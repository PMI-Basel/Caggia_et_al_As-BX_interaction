---
title: "Arsenic Plant - 03: Alpha Diversity"
author: "Jan Waelchli"
geometry: margin=2cm
output:
  pdf_document:
    toc: yes
    toc_depth: 3
---

\pagebreak

```{r setup, include=FALSE, echo=F, warning=F, message=F,}

##clear the object from memory
rm(list=ls())

#knitr settings
knitr::opts_chunk$set(echo=TRUE, fig.align="center")
options(tinytex.verbose = TRUE)

#set seed
set.seed(100)

#paths
paths <- list(functions="functions/")

## set source to file location
library(rstudioapi)
setwd(dirname(getActiveDocumentContext()$path))

## load functions
source(paste0(paths$functions,"functions.R"))
functions(path="functions/")

## installs (if necessary) and loads libraries
libraries()
library(lme4)

```

```{r import, echo=F, message=F, warning=F}

# Import

# set wd to RDS files
setwd("interim/01_Import_Normalization")

#cImport RDS files
bDESIGN <- readRDS("bDESIGN.RDS")
bDAT <- readRDS("bDAT.RDS")
bDAT_norm <- readRDS("bDAT_norm.RDS")

fDESIGN <- readRDS("fDESIGN.RDS")
fDAT <- readRDS("fDAT.RDS")
fDAT_norm <- readRDS("fDAT_norm.RDS")

level_cols_Arsenic <- readRDS("level_cols_Arsenic.RDS")
level_cols_Type <- readRDS("level_cols_Type.RDS")

```
   

# Alpha diversity

## Shannon diversity

Method: We calculated Shannon diversity for each sample.

```{r a-div shannon, warning=F, echo=F, message=F, eval=T}

#Bacteria

#compute alpha div
asv_diversity <- vegan::diversity(bDAT_norm, index="shannon", MARGIN=2)
alpha_diversity_bDAT_summary <- cbind(asv_diversity, bDESIGN)
rm(asv_diversity)

#Fungi

#compute alpha div
asv_diversity <- vegan::diversity(fDAT_norm, index="shannon", MARGIN=2)
alpha_diversity_fDAT_summary <- cbind(asv_diversity, fDESIGN)
rm(asv_diversity)

```

### Bacteria - ANOVA

```{r a-div models bacteria, warning=F, echo=F, message=F, eval=T}

#group_experiment_timepoint
#F test for sample groups by group_experiment_timepoint
balpha_group_experiment_timepoint_aov <- aov(asv_diversity ~ Arsenic * Type, data=alpha_diversity_bDAT_summary) #model
pander(summary(balpha_group_experiment_timepoint_aov), caption = "Bacteria: Arsenic effect")

```

### Fungi - ANOVA

```{r a-div models fungi, warning=F, echo=F, message=F, eval=T}


falpha_group_experiment_timepoint_aov <- aov(asv_diversity ~ Arsenic * Type, data=alpha_diversity_fDAT_summary) #model
pander(summary(falpha_group_experiment_timepoint_aov), caption = "Fungi: Arsenic effect")

#export as table
# temp1 <- data.frame(summary(balpha_group_experiment_timepoint_aov)[[1]])
# temp1 <- rownames_to_column(temp1, "factors")
# colnames(temp1)[2] <- "taxa"
# temp1$taxa <- "bacteria"
# temp2 <- data.frame(summary(falpha_group_experiment_timepoint_aov)[[1]])
# temp2 <- rownames_to_column(temp2, "factors")
# colnames(temp2)[2] <- "taxa"
# temp2$taxa <- "fungi"
# temp3 <- rbind(temp1, temp2)
# write.csv(temp3, "paper_tables/alpha_div.csv", row.names = F)
# rm(temp1, temp2, temp3)

```

Because we found significant differences in bacterial alpha diversity between the different arsenic treatments and within the arsenic:type interaction, we check how arsenic shifts the alpha diversity in the different plant compartments (type).

\pagebreak

### Bacteria - Tukey post-hoc

```{r a-div Arsenic effect bacteria, warning=F, echo=F, message=F, eval=T}


# ### BACTERIA ###

#all
data <- droplevels(alpha_diversity_bDAT_summary)
DESIGN <- droplevels(bDESIGN)

#Arsenic
#F test for sample groups by Arsenic
alpha_Arsenic_aov <- aov(asv_diversity ~ group, data=data) #model
alpha_Arsenic_aov_sum <- summary(alpha_Arsenic_aov)
### pair-wise tests
alpha_Arsenic_aov_tukey <- emmeans(alpha_Arsenic_aov, "group")  # library(emmeans)
alpha_Arsenic_aov_tukey_letters <- cld(alpha_Arsenic_aov_tukey, Letter="abcdefghi", alpha=0.1)
row.names(alpha_Arsenic_aov_tukey_letters) <- alpha_Arsenic_aov_tukey_letters[,1]
alpha_Arsenic_aov_tukey_letters <- alpha_Arsenic_aov_tukey_letters[levels(DESIGN$group),]
# means
alpha_Arsenic_means <- aggregate(data$asv_diversity,list(data$group), mean)
row.names(alpha_Arsenic_means) <- alpha_Arsenic_means[,1]
alpha_Arsenic_means <- alpha_Arsenic_means[levels(DESIGN$group),]
# table
balpha_table_Arsenic <- cbind(Shannon=alpha_Arsenic_means[,2], alpha_Arsenic_aov_tukey_letters[,2:7])
balpha_table_Arsenic <- balpha_table_Arsenic[c(1,4,7,2,5,8,3,6,9),c(1,7)]

pander(balpha_table_Arsenic, caption = "Bacteria: Arsenic effect")

```

**Conclusion:** There is no constant evidence that arsenic alters the alpha diversity in plant compartments. In soil we find statistical support that samples with no arsenic have lower alpha diversity. But considering those samples, we find a few samples with a much lower diversity than the rest of the samples.

### Fungi - Tukey post-hoc

```{r a-div Arsenic effect fungi, warning=F, echo=F, message=F, eval=T}


### FUNGI ###

#all
data <- droplevels(alpha_diversity_fDAT_summary)
DESIGN <- droplevels(fDESIGN)

#Arsenic
#F test for sample groups by Arsenic
alpha_Arsenic_aov <- aov(asv_diversity ~ group, data=data) #model
alpha_Arsenic_aov_sum <- summary(alpha_Arsenic_aov)
### pair-wise tests
alpha_Arsenic_aov_tukey <- emmeans(alpha_Arsenic_aov, "group")  # library(emmeans)
alpha_Arsenic_aov_tukey_letters <- cld(alpha_Arsenic_aov_tukey, Letter="abcdefghi", alpha=0.1)
row.names(alpha_Arsenic_aov_tukey_letters) <- alpha_Arsenic_aov_tukey_letters[,1]
alpha_Arsenic_aov_tukey_letters <- alpha_Arsenic_aov_tukey_letters[levels(DESIGN$group),]
# means
alpha_Arsenic_means <- aggregate(data$asv_diversity,list(data$group), mean)
row.names(alpha_Arsenic_means) <- alpha_Arsenic_means[,1]
alpha_Arsenic_means <- alpha_Arsenic_means[levels(DESIGN$group),]
# table
falpha_table_Arsenic <- cbind(Shannon=alpha_Arsenic_means[,2], alpha_Arsenic_aov_tukey_letters[,2:7])
falpha_table_Arsenic <- falpha_table_Arsenic[c(1,4,7,2,5,8,3,6),c(1,7)]

pander(falpha_table_Arsenic, caption = "Fungi: Arsenic effect")



#export for paper
# temp1 <- balpha_table_Arsenic
# temp1 <- add_column(temp1, Arsenic=rep(c("0ppm", "100ppm", "200ppm"),3), .before=1)
# temp1 <- add_column(temp1, Type=rep(c("Leaves", "Roots", "Soil"),each=3), .before=1)
# temp1 <- add_column(temp1, Taxa="Bacteria", .before=1)
# temp2 <- falpha_table_Arsenic
# temp2 <- add_column(temp2, Arsenic=c(rep(c("0ppm", "100ppm", "200ppm"),2),c("0ppm", "100ppm")), .before=1)
# temp2 <- add_column(temp2, Type=c(rep(c("Roots", "Soil"),each=3), "Kernel", "Kernel"), .before=1)
# temp2 <- add_column(temp2, Taxa="Bacteria", .before=1)
# temp3 <- rbind(temp1, temp2)
# write.csv(temp3, "paper_tables/alpha_div_pairwise.csv", row.names = F)
# rm(temp1, temp2, temp3)

```

**Conclusion:** We find no statistical support that Arsenic alters fungal alpha diversity in the different compartments.

\pagebreak

## Figure 4 | shannon diversity

\vspace{5mm}

```{r plot a-div, echo=F, message=F, warning=F, eval=T}

### BACTERIA

letters <- data.frame(label=trimws(balpha_table_Arsenic$.group),
                      Timepoint=rep(c("Leaves", "Roots", "Soil"), 3),
                      Arsenic=rep(c("0ppm","100ppm", "200ppm"),each=3),
                      x=c(0.8, 1, 1.2, 1.8, 2, 2.2, 2.8, 3, 3.2), 
                      y=c(6.5,6.5,6.5 ,6.5,6.5,6.5, 6.5,6.5,6.5))

bac_plot <- ggplot(alpha_diversity_bDAT_summary, aes(y=asv_diversity, x=Type, fill=Arsenic)) +
              geom_boxplot(position=position_dodge2(width=0.75, preserve="single"),outlier.colour = NA)+
              geom_jitter(col="gray40", position=position_dodge(width=0.75), aes(group=Arsenic))+
              theme_bw() +
              theme(legend.position="none", axis.ticks.x=element_blank()) +
              ylab("Shanon Diversity")+
              xlab("")+
              scale_fill_manual(values=level_cols_Arsenic)+
              labs(title = "Bacteria: Alpha diversity", subtitle = "alpha diversity ~ Arsenic")+
              scale_x_discrete(position = "top")+
              geom_text(data = letters, aes(x = x, y = y, label = label, Timepoint=Timepoint),size=3, col="dimgrey")

### FUNGI

letters <- data.frame(label=c(trimws(falpha_table_Arsenic$.group),NA),
                      Timepoint=rep(c("Roots", "Soil", "Kernels"), 3),
                      Arsenic=rep(c("0ppm","100ppm", "200ppm"),each=3),
                      x=c(0.8, 1, 1.2, 1.8, 2, 2.2, 2.9, 3.1, 3.2), 
                      y=c(4.5,4.5,4.5 ,4.5,4.5,4.5, 4.5,4.5,4.5))

fun_plot <- ggplot(alpha_diversity_fDAT_summary, aes(y=asv_diversity, x=Type, fill=Arsenic)) +
              geom_boxplot(position=position_dodge2(width=0.75, preserve="single"),outlier.colour = NA)+
              geom_jitter(col="gray40", position=position_dodge(width=0.75), aes(group=Arsenic))+
              theme_bw() +
              theme(legend.position="none", axis.ticks.x=element_blank()) +
              ylab("Shanon Diversity")+
              xlab("")+
              scale_fill_manual(values=level_cols_Arsenic)+
              labs(title = "Fungi: Alpha diversity", subtitle = "alpha diversity ~ Arsenic")+
              scale_x_discrete(position = "top")+
              geom_text(data = letters, aes(x = x, y = y, label = label, Timepoint=Timepoint),size=3, col="dimgrey")


#combine the two plots (library cowplot)
fig4 <- plot_grid(bac_plot + theme(legend.position="none"),
               fun_plot + theme(legend.position="none") + labs(colour=""),
               labels=c("A","B"),
               align = "hv",
               nrow=1)

#add legend
legend <- get_legend(bac_plot + theme(legend.position="bottom") + labs(fill="Arsenic"))
fig4 <- plot_grid(fig4, legend, nrow=2, rel_heights=c(1, .1))

#print
fig4

#saveRDS(bac_plot, "paper_figs/RDS/fig4.1.RDS")
#saveRDS(fun_plot, "paper_figs/RDS/fig4.2.RDS")

```

```{r export RDA files, , echo=F, message=F, warning=F}

# create directory
dir.create("interim")
dir.create("interim/03_Alpha_Diversity")

## set output directory
setwd("interim/03_Alpha_Diversity")

#save objects needed in the following scripts as RDA
saveRDS(alpha_diversity_bDAT_summary, "alpha_diversity_bDAT_summary.RDS")
saveRDS(alpha_diversity_fDAT_summary, "alpha_diversity_fDAT_summary.RDS")

```

\pagebreak

