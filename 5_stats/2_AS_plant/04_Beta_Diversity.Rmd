---
title: "Arsenic Plant - 04: Beta Diversity"
author: "Jan Waelchli"
geometry: margin=2cm
output:
  pdf_document:
    toc: yes
    toc_depth: 3
---
   
\pagebreak

```{r setup, include=FALSE, echo=F, warning=F, message=F,}

##clear the object from memory
rm(list=ls())

#knitr settings
knitr::opts_chunk$set(echo=TRUE, fig.align="center")
options(tinytex.verbose = TRUE)

#set seed
set.seed(100)

#paths
paths <- list(functions="functions/")

## set source to file location
library(rstudioapi)
setwd(dirname(getActiveDocumentContext()$path))

## load functions
source(paste0(paths$functions,"functions.R"))
functions(path="functions/")

## installs (if necessary) and loads libraries
libraries()

```

```{r paths, echo=F, message=F, warning=F}

# Import

#set wd to RDS files
setwd("interim/01_Import_Normalization")
#Import RDS files
bDESIGN <- readRDS("bDESIGN.RDS")
bDAT <- readRDS("bDAT.RDS")
bDAT_norm <- readRDS("bDAT_norm.RDS")

fDESIGN <- readRDS("fDESIGN.RDS")
fDAT <- readRDS("fDAT.RDS")
fDAT_norm <- readRDS("fDAT_norm.RDS")

level_cols_Arsenic <- readRDS("level_cols_Arsenic.RDS")
level_cols_Type <- readRDS("level_cols_Type.RDS")

bPHYSEQ <- readRDS("../02_Taxa_Analysis/bPHYSEQ.RDS")
fPHYSEQ <- readRDS("../02_Taxa_Analysis/fPHYSEQ.RDS")

#change color order
level_cols_Type <- level_cols_Type[c(2,3,1,4)]

```

# Beta diversity

## PERMANOVA

We use the function 'adonis2()' (package vegan) to analyse the beta diversity with a PERMANOVA (permutations = 999).  First we investigate the full model to see which factors alters the beta diversity.

### Bacteria

```{r bray curtis distance bacteria all, warning=F, echo=F, eval=T}

### BACTERIA ###

#all
all_dist <- vegdist(t(bDAT), method="bray")
all_dist_paov <- adonis2(all_dist ~ Arsenic * Type, data=bDESIGN, permutations=999)
pander(all_dist_paov, caption="Bacteria: all")

#update Bioconductor package "ShortReads" to 1.46 or newer or use for older packages:
#all_dist_paov <- adonis2(all_dist ~ Arsenic * Type, data=bDESIGN, permutations=999)
#pander(all_dist_paov$aov.tab, caption="Bacteria: all")

```

**Conclusion:** There is an arsenic effect on the bacterial composition.

We test if the bacterial compositions differ between 0ppm and 200ppm arsenic concentration in different compartments.

```{r bray curtis distance bacteria Arsenic 100ppm, warning=F, echo=F, eval=T, message=F}

#function
bac_dist_paov <- function(type, arsenic){

  bPHYSEQ_sub <- prune_samples(sample_data(bPHYSEQ)$Type == type & sample_data(bPHYSEQ)$Arsenic %in% arsenic, bPHYSEQ)
  bDAT_sub <- otu_table(bPHYSEQ_sub)
  dist_sub <- vegdist(t(bDAT_sub), method="bray")
  dist_sub_paov <- adonis2(dist_sub ~ Arsenic, data=bDESIGN[bDESIGN$Type == type & bDESIGN$Arsenic %in% arsenic,], permutations=999)
  
  dist_sub_paov_df <- as.data.frame(dist_sub_paov)
  dist_sub_paov_df <- dist_sub_paov_df[,colnames(dist_sub_paov_df)!="Df"]
  dist_sub_paov_df <- rownames_to_column(dist_sub_paov_df, "Factors")
  colnames(dist_sub_paov_df)[ncol(dist_sub_paov_df)] <- "p"
  dist_sub_paov_df <- add_column(dist_sub_paov_df, Type=type, .before = 1)
  
  return(dist_sub_paov_df)
}

#100ppm
bdist_100ppm_paov <- rbind(
  bac_dist_paov(type="Leaves", arsenic=c("0ppm","100ppm")),
  bac_dist_paov(type="Roots", arsenic=c("0ppm","100ppm")),
  bac_dist_paov(type="Soil", arsenic=c("0ppm","100ppm"))
)

#adjust p values
padj <- na.omit(bdist_100ppm_paov$p) %>% p.adjust(.,method = "BH")
bdist_100ppm_paov$p_adj <- as.vector(rbind(padj, NA, NA))

pander(bdist_100ppm_paov, caption = "Arsenic effect (100ppm) in different compartments")

```

```{r bray curtis distance bacteria Arsenic 200ppm, warning=F, echo=F, eval=T, message=F}

#200ppm
bdist_200ppm_paov <- rbind(
  bac_dist_paov(type="Leaves", arsenic=c("0ppm","200ppm")),
  bac_dist_paov(type="Roots", arsenic=c("0ppm","200ppm")),
  bac_dist_paov(type="Soil", arsenic=c("0ppm","200ppm"))
)

#adjust p values
padj <- na.omit(bdist_200ppm_paov$p) %>% p.adjust(.,method = "BH")
bdist_200ppm_paov$p_adj <- as.vector(rbind(padj, NA, NA))

pander(bdist_200ppm_paov, caption = "Arsenic effect (200ppm) in different compartments")

```

**Conclusion:** The bacterial beta diversity is not altered by treating the soil with Arsenic.

\pagebreak

## Figure 5 | Bacteria: PCoA ordination

\vspace{5mm}

```{r bacteria ordination all, echo=F, warning=F, message=F, eval=T}
#fig.height=5, fig.width=6

#all
source("functions/axis_label_pco.R")
bPHYSEQ_PCoA_bray <- phyloseq::ordinate(bPHYSEQ, method="PCoA", distance="bray")
p0 <- phyloseq::plot_ordination(bPHYSEQ, bPHYSEQ_PCoA_bray, color="Type", shape="Arsenic", title = "Bacteria PCoA", axes = c(1,2)) #, label="Label"
p0$layers <- p0$layers[-1]
p0 <- p0 + geom_point(size=3)
p0 <- p0 + scale_color_manual(values=level_cols_Type)
p0 <- p0 + scale_shape_manual(values=c(15,16,17))
p0 <- p0 + scale_size_manual(values=c(2,3))
p0 <- p0 + theme_bw()
#p0 <- p0 + facet_wrap(~Type)
fig5 <- p0
#png("fig1.png",width=3200, height=2600, res=600)
fig5
#dev.off()

#separated by compartments
#p0 <- p0 + facet_wrap(~Type)
#fig5 <- p0
#fig5

```

## Figure 6 | Bacteria: CAP ordination

```{r bacteria all CAP, echo=F, warning=F, eval=T}

# Figure X | PCoA ordination all

#bray for plot (we plot by type and arsenic)
all_CAP_bray <- ordinate(bPHYSEQ, method="CAP", ~ Arsenic * Type, distance="bray") #CAP
all_CAP_bray_var_tbl <- variability_table(all_CAP_bray) # extract variation details
all_CAP_bray_anova <- anova.cca(all_CAP_bray, permutations=999) #Anova

#pander(all_CAP_bray_anova[1:4], caption="all")

#prune PHYSEQ for plot
phylum.sum <- tapply(taxa_sums(bPHYSEQ), tax_table(bPHYSEQ)[, "labels"], sum, na.rm=T)
topphyla <- names(sort(phylum.sum, T))[1:6]
all_phy_sub <- prune_taxa((tax_table(bPHYSEQ)[, "labels"] %in% topphyla), bPHYSEQ)

# plot sample scores
score <- paste("[ ~ Arsenic * Type: ",
               format(all_CAP_bray_var_tbl["constrained", "proportion"] * 100, digits=2, nsmall=1),
               "% of variance, P = ",
               format(all_CAP_bray_anova[1, 4], digits=2),
               "]", sep = "")

#plot
p0 <- phyloseq::plot_ordination(all_phy_sub, all_CAP_bray, color="Type", shape="Arsenic", title =  "Bacteria CAP")
p0$layers <- p0$layers[-1]
p0 <- p0 + geom_point(size=3)
p0 <- p0 + scale_color_manual(values=level_cols_Type)
p0 <- p0 + scale_shape_manual(values=c(15,16,17))
p0 <- p0 + scale_size_manual(values=c(2,3))
p0 <- p0 + labs(subtitle = score)
p0 <- p0 + theme_bw()
CAP_all <- p0
par(mar=c(4,4,4,4), oma=c(4,4,4,4))
print(CAP_all)

# saveRDS(CAP_all, "paper_figs/RDS/fig6.RDS")

#print with facet grid
# p0 <- p0 + facet_wrap(~Type)
# CAP_all <- p0
# par(mar=c(4,4,4,4), oma=c(4,4,4,4))
# print(CAP_all)

```

\pagebreak


### Fungi

```{r bray curtis distance fungi all, warning=F, echo=F, eval=T}

### FUNGI ###

#all
all_dist <- vegdist(t(fDAT), method="bray")
all_dist_paov <- adonis2(all_dist ~ Arsenic * Type, data=fDESIGN, permutations=999)
pander(all_dist_paov, caption="Fungi: all")

#update Bioconductor package "ShortReads" to 1.46 or newer or use for older packages:
#all_dist_paov <- adonis2(all_dist ~ Arsenic * Type, data=fDESIGN, permutations=999)
#pander(all_dist_paov$aov.tab, caption="Fungi: all")

```

**Conclusion:** No effect was found on the beta diversity.

We test if the arsenic treatments alter the bacterial compositions in different compartments.

```{r bray curtis distance fungi Arsenic 100ppm, warning=F, echo=F, eval=T, message=F}

#function
fun_dist_paov <- function(type, arsenic){

  fPHYSEQ_sub <- prune_samples(sample_data(fPHYSEQ)$Type == type & sample_data(fPHYSEQ)$Arsenic %in% arsenic, fPHYSEQ)
  fDAT_sub <- otu_table(fPHYSEQ_sub)
  dist_sub <- vegdist(t(fDAT_sub), method="bray")
  dist_sub_paov <- adonis2(dist_sub ~ Arsenic, data=fDESIGN[fDESIGN$Type == type & fDESIGN$Arsenic %in% arsenic,], permutations=999)
  
  dist_sub_paov_df <- as.data.frame(dist_sub_paov)
  dist_sub_paov_df <- dist_sub_paov_df[,colnames(dist_sub_paov_df)!="Df"]
  dist_sub_paov_df <- rownames_to_column(dist_sub_paov_df, "Factors")
  colnames(dist_sub_paov_df)[ncol(dist_sub_paov_df)] <- "p"
  dist_sub_paov_df <- add_column(dist_sub_paov_df, Type=type, .before = 1)
  
  return(dist_sub_paov_df)
}

#100ppm
fdist_100ppm_paov <- rbind(
  fun_dist_paov(type="Roots", arsenic=c("0ppm","100ppm")),
  fun_dist_paov(type="Soil", arsenic=c("0ppm","100ppm")),
  fun_dist_paov(type="Kernels", arsenic=c("0ppm","100ppm"))
)

#adjust p values
padj <- na.omit(fdist_100ppm_paov$p) %>% p.adjust(.,method = "BH")
fdist_100ppm_paov$p_adj <- as.vector(rbind(padj, NA, NA))

pander(fdist_100ppm_paov, caption = "Arsenic effect (100ppm) in different compartments")

```

**Conclusion:** The fungal beta diversity is not altered by treating the soil with 100ppm Arsenic.

We test if the fungal compositions differ between 0ppm and 200ppm arsenic concentration.

```{r bray curtis distance fungi Arsenic 200ppm, warning=F, echo=F, eval=T}

#200ppm
fdist_200ppm_paov <- rbind(
  fun_dist_paov(type="Roots", arsenic=c("0ppm","200ppm")),
  fun_dist_paov(type="Soil", arsenic=c("0ppm","200ppm"))
)

#adjust p values
padj <- na.omit(fdist_200ppm_paov$p) %>% p.adjust(.,method = "BH")
fdist_200ppm_paov$p_adj <- as.vector(rbind(padj, NA, NA))

pander(fdist_200ppm_paov, caption = "Arsenic effect (200ppm) in different compartments")

# #export as csv.
temp1 <- rbind(bdist_100ppm_paov, bdist_200ppm_paov)
temp1 <- add_column(temp1, taxa="bacteria", .before = 1)
temp2 <- rbind(fdist_100ppm_paov, fdist_200ppm_paov)
temp2 <- add_column(temp2, taxa="fungi", .before = 1)
temp3 <- rbind(temp1, temp2)
#write.csv(temp3, "paper_tables/beta_div.csv", row.names = F)
rm(temp1, temp2, temp3)

```

**Conclusion:** The fungal beta diversity is not altered by treating the soil with Arsenic.

\pagebreak

## Figure 7 | Fungi: PCoA ordination

\vspace{5mm}

```{r fungi ordination all, echo=F, warning=F, message=F, eval=T}
#fig.height=5, fig.width=6

#all
source("functions/axis_label_pco.R")
fPHYSEQ_PCoA_bray <- phyloseq::ordinate(fPHYSEQ, method="PCoA", distance="bray")
p0 <- phyloseq::plot_ordination(fPHYSEQ, fPHYSEQ_PCoA_bray, color="Type", shape="Arsenic", title = "Fungi PCoA", axes = c(1,2)) #, label="Label"
p0$layers <- p0$layers[-1]
p0 <- p0 + geom_point(size=3)
p0 <- p0 + scale_color_manual(values=level_cols_Type)
p0 <- p0 + scale_shape_manual(values=c(15,16,17))
p0 <- p0 + scale_size_manual(values=c(2,3))
p0 <- p0 + theme_bw()
#p0 <- p0 + facet_wrap(~Type)
fig5 <- p0
#png("fig1.png",width=3200, height=2600, res=600)
fig5
#dev.off()

#separated by compartments
# p0 <- p0 + facet_wrap(~Type)
# fig5 <- p0
# fig5

```

\pagebreak

## Figure 8 | Fungi: CAP ordination

\vspace{5mm}

```{r fungi all CAP, echo=F, warning=F, eval=T}

# Figure X | PCoA ordination all

#all

all_CAP_bray <- ordinate(fPHYSEQ, method="CAP", ~ Arsenic * Type, distance="bray") #CAP
all_CAP_bray_var_tbl <- variability_table(all_CAP_bray) # extract variation details
all_CAP_bray_anova <- anova.cca(all_CAP_bray, permutations=999) #Anova

#pander(all_CAP_bray_anova[1:4], caption="all")

#prune PHYSEQ for plot
phylum.sum <- tapply(taxa_sums(fPHYSEQ), tax_table(fPHYSEQ)[, "labels"], sum, na.rm=T)
topphyla <- names(sort(phylum.sum, T))[1:6]
all_phy_sub <- prune_taxa((tax_table(fPHYSEQ)[, "labels"] %in% topphyla), fPHYSEQ)

# plot sample scores
score <- paste("[ ~ Arsenic * Type: ",
               format(all_CAP_bray_var_tbl["constrained", "proportion"] * 100, digits=2, nsmall=1),
               "% of variance, P = ",
               format(all_CAP_bray_anova[1, 4], digits=2),
               "]", sep = "")

#plot
p0 <- phyloseq::plot_ordination(all_phy_sub, all_CAP_bray, color="Type", shape="Arsenic", title =  "Fungi CAP")
p0$layers <- p0$layers[-1]
p0 <- p0 + geom_point(size=3)
p0 <- p0 + scale_color_manual(values=level_cols_Type)
p0 <- p0 + scale_shape_manual(values=c(15,16,17))
p0 <- p0 + scale_size_manual(values=c(2,3))
p0 <- p0 + labs(subtitle = score)
p0 <- p0 + theme_bw()

CAP_all <- p0
par(mar=c(4,4,4,4), oma=c(4,4,4,4))
print(CAP_all)

#saveRDS(CAP_all, "paper_figs/RDS/fig8.RDS")

#print with facet grid
# p0 <- p0 + facet_wrap(~Type)
# CAP_all <- p0
# par(mar=c(4,4,4,4), oma=c(4,4,4,4))
# print(CAP_all)

```

