---
title: "Arsenic Soil - 04: Beta Diversity"
author: "Jan Waelchli"
geometry: margin=2cm
output:
  pdf_document:
    toc: yes
    toc_depth: 3
---
   
\pagebreak

```{r setup, include=FALSE, echo=F, warning=F, message=F,}

##clear the object from memory
rm(list=ls())

#knitr settings
knitr::opts_chunk$set(echo=TRUE, fig.align="center")
options(tinytex.verbose = TRUE)

#set seed
set.seed(100)

#paths
paths <- list(functions="functions/")

## set source to file location
library(rstudioapi)
setwd(dirname(getActiveDocumentContext()$path))

## load functions
source(paste0(paths$functions,"functions.R"))
functions(path="functions/")

## installs (if necessary) and loads libraries
libraries()
library(tibble)

```

```{r paths, echo=F, message=F, warning=F}

# Import

#set wd to RDS files
setwd("interim/01_Import_Normalization")
#Import RDS files
bDESIGN <- readRDS("bDESIGN.RDS")
bDAT <- readRDS("bDAT.RDS")
bDAT_rare <- readRDS("bDAT_rare.RDS")
b_rare <- readRDS("b_rare.RDS")

fDESIGN <- readRDS("fDESIGN.RDS")
fDAT <- readRDS("fDAT.RDS")
fDAT_rare <- readRDS("fDAT_rare.RDS")
f_rare <- readRDS("f_rare.RDS")


level_cols_Arsenic <- readRDS("level_cols_Arsenic.RDS")
level_cols_Timepoint <- readRDS("level_cols_Timepoint.RDS")

bPHYSEQ <- readRDS("../02_Taxa_Analysis/bPHYSEQ.RDS")
fPHYSEQ <- readRDS("../02_Taxa_Analysis/fPHYSEQ.RDS")

```

# Beta diversity

## PERMANOVA

We use the function 'adonis2()' (package vegan) to analyse the beta diversity with a PERMANOVA (permutations = 999).  First we investigate the full model to see which factors alters the beta diversity.

### Bacteria

```{r bray curtis distance bacteria all, warning=F, echo=F, eval=T}

### BACTERIA ###

levels(bPHYSEQ@sam_data$Timepoint) <- c("0 months", "1 month", "2 months", "3 months", "4 months", "5 months")
levels(bDESIGN$Timepoint) <- c("0 months", "1 month", "2 months", "3 months", "4 months", "5 months")

#all
all_dist <- vegdist(t(bDAT), method="bray")
all_dist_paov <- adonis2(all_dist ~ Arsenic * Timepoint, data=bDESIGN, permutations=999)
pander(all_dist_paov, caption="Bacteria: all")

```

**Conclusion:** We find differences in the beta diversity over time. There is trend for an interaction effect of arsenic and time. Therefore we investigate in a next step the arsenic effect for each timepoint.

We test if the bacterial compositions differ between 0ppm and 100ppm arsenic concentration over 5 months.

```{r bray curtis distance bacteria Arsenic 100ppm, warning=F, echo=F, eval=T}

### BACTERIA ###

#function
bac_dist_paov <- function(timepoint, arsenic){

  bPHYSEQ_sub <- prune_samples(sample_data(bPHYSEQ)$Timepoint == timepoint & sample_data(bPHYSEQ)$Arsenic %in% arsenic, bPHYSEQ)
  bDAT_sub <- otu_table(bPHYSEQ_sub)
  dist_sub <- vegdist(t(bDAT_sub), method="bray")
  dist_sub_paov <- adonis2(dist_sub ~ Arsenic, data=bDESIGN[bDESIGN$Timepoint == timepoint & bDESIGN$Arsenic %in% arsenic,], permutations=999)
  
  dist_sub_paov_df <- as.data.frame(dist_sub_paov)
  dist_sub_paov_df <- dist_sub_paov_df[,colnames(dist_sub_paov_df)!="Df"]
  dist_sub_paov_df <- rownames_to_column(dist_sub_paov_df, "Factors")
  colnames(dist_sub_paov_df)[ncol(dist_sub_paov_df)] <- "p"
  dist_sub_paov_df <- add_column(dist_sub_paov_df, Timepoint=timepoint, .before = 1)
  
  return(dist_sub_paov_df)
}

#100ppm
bdist_100ppm_paov <- rbind(
  bac_dist_paov(timepoint="0 months", arsenic=c("0ppm","100ppm")),
  bac_dist_paov(timepoint="1 month", arsenic=c("0ppm","100ppm")),
  bac_dist_paov(timepoint="2 months", arsenic=c("0ppm","100ppm")),
  bac_dist_paov(timepoint="3 months", arsenic=c("0ppm","100ppm")),
  bac_dist_paov(timepoint="4 months", arsenic=c("0ppm","100ppm")),
  bac_dist_paov(timepoint="5 months", arsenic=c("0ppm","100ppm"))
)

#adjust p values
padj <- na.omit(bdist_100ppm_paov$p) %>% p.adjust(.,method = "BH")
bdist_100ppm_paov$p_adj <- as.vector(rbind(padj, NA, NA))

pander(bdist_100ppm_paov, caption = "Arsenic effect (100ppm) over 5 months")

```

**Conclusion:** The bacterial beta diversity is not altered by treating the soil with 100ppm Arsenic.

\pagebreak

We test if the bacterial compositions differ between 0ppm and 200ppm arsenic concentration over 5 months.

```{r bray curtis distance bacteria Arsenic 200ppm, warning=F, echo=F, eval=T}

### BACTERIA ###

#200ppm
bdist_200ppm_paov <- rbind(
  bac_dist_paov(timepoint="0 months", arsenic=c("0ppm","200ppm")),
  bac_dist_paov(timepoint="1 month", arsenic=c("0ppm","200ppm")),
  bac_dist_paov(timepoint="2 months", arsenic=c("0ppm","200ppm")),
  bac_dist_paov(timepoint="3 months", arsenic=c("0ppm","200ppm")),
  bac_dist_paov(timepoint="4 months", arsenic=c("0ppm","200ppm")),
  bac_dist_paov(timepoint="5 months", arsenic=c("0ppm","200ppm"))
)

#adjust p values
padj <- na.omit(bdist_200ppm_paov$p) %>% p.adjust(.,method = "BH")
bdist_200ppm_paov$p_adj <- as.vector(rbind(padj, NA, NA))

pander(bdist_200ppm_paov, caption = "Arsenic effect (200ppm) over 5 months")

```

**Conclusion:** The bacterial beta diversity is not affected by the arsenic concentration of 200ppm.

\pagebreak

## Figure 5 | Bacteria: PCoA ordination

\vspace{5mm}

```{r bacteria ordination all, echo=F, warning=F, message=F, eval=T}
#fig.height=5, fig.width=6

names(level_cols_Timepoint) <- c("0 months", "1 month", "2 months", "3 months", "4 months", "5 months")

#all
source("functions/axis_label_pco.R")
bPHYSEQ_PCoA_bray <- phyloseq::ordinate(bPHYSEQ, method="PCoA", distance="bray")
p0 <- phyloseq::plot_ordination(bPHYSEQ, bPHYSEQ_PCoA_bray, color="Timepoint", shape="Arsenic", title = "Bacteria: PCoA", axes = c(1,2)) #, label="Label"
p0$layers <- p0$layers[-1]
p0 <- p0 + geom_point(size=3)
p0 <- p0 + scale_color_manual(values=level_cols_Timepoint)
p0 <- p0 + scale_shape_manual(values=c(15,16,17))
p0 <- p0 + scale_size_manual(values=c(2,3))
p0 <- p0 + theme_bw()
fig5 <- p0
#png("fig1.png",width=3200, height=2600, res=600)
fig5
#dev.off()

```

## Figure 6 | Bacteria: CAP ordination

\vspace{5mm}

```{r bacteria all CAP, echo=F, warning=F, eval=T}

# Figure X | PCoA ordination all

#all

all_CAP_bray <- ordinate(bPHYSEQ, method="CAP", ~ Arsenic * Timepoint, distance="bray") #CAP
all_CAP_bray_var_tbl <- variability_table(all_CAP_bray) # extract variation details
all_CAP_bray_anova <- anova.cca(all_CAP_bray, permutations=999) #Anova

#pander(all_CAP_bray_anova[1:4], caption="all")

#prune PHYSEQ for plot
phylum.sum <- tapply(taxa_sums(bPHYSEQ), tax_table(bPHYSEQ)[, "labels"], sum, na.rm=T)
topphyla <- names(sort(phylum.sum, T))[1:6]
all_phy_sub <- prune_taxa((tax_table(bPHYSEQ)[, "labels"] %in% topphyla), bPHYSEQ)

# plot sample scores
score <- paste("[ ~ Arsenic * Timepoint: ",
               format(all_CAP_bray_var_tbl["constrained", "proportion"] * 100, digits=2, nsmall=1),
               "% of variance, P = ",
               format(all_CAP_bray_anova[1, 4], digits=2),
               "]", sep = "")

#plot
p0 <- phyloseq::plot_ordination(all_phy_sub, all_CAP_bray, color="Timepoint", shape="Arsenic", title =  "Bacteria: CAP")
p0$layers <- p0$layers[-1]
p0 <- p0 + geom_point(size=3)
p0 <- p0 + scale_color_manual(values=level_cols_Timepoint)
p0 <- p0 + scale_shape_manual(values=c(15,16,17))
p0 <- p0 + scale_size_manual(values=c(2,3))
p0 <- p0 + labs(subtitle = score)
p0 <- p0 + theme_bw()
CAP_all <- p0
par(mar=c(4,4,4,4), oma=c(4,4,4,4))
print(CAP_all)

#saveRDS(CAP_all, "paper_figs/RDS/fig6.RDS")

```


\pagebreak


### Fungi

```{r bray curtis distance fungi all, warning=F, echo=F, eval=T}

### FUNGI ###

levels(fPHYSEQ@sam_data$Timepoint) <- c("0 months", "1 month", "2 months", "3 months", "4 months", "5 months")
levels(fDESIGN$Timepoint) <- c("0 months", "1 month", "2 months", "3 months", "4 months", "5 months")

#all
all_dist <- vegdist(t(fDAT), method="bray")
all_dist_paov <- adonis2(all_dist ~ Arsenic * Timepoint, data=fDESIGN, permutations=999)
pander(all_dist_paov, caption="Fungi: all")

```

**Conclusion:** We find differences in the beta diversity over time. There is a trend for an interaction effect of arsenic and time. Therefore we investigate in a next step the arsenic effect for each timepoint.

We test if the fungal compositions differ between 0ppm and 100ppm arsenic concentration over 5 months.

```{r bray curtis distance fungi Arsenic 100ppm, warning=F, echo=F, eval=T}

### FUNGI ###

##100ppm
#function
fun_dist_paov <- function(timepoint, arsenic){

  fPHYSEQ_sub <- prune_samples(sample_data(fPHYSEQ)$Timepoint == timepoint & sample_data(fPHYSEQ)$Arsenic %in% arsenic, fPHYSEQ)
  fDAT_sub <- otu_table(fPHYSEQ_sub)
  dist_sub <- vegdist(t(fDAT_sub), method="bray")
  dist_sub_paov <- adonis2(dist_sub ~ Arsenic, data=fDESIGN[fDESIGN$Timepoint == timepoint & fDESIGN$Arsenic %in% arsenic,], permutations=999)
  
  dist_sub_paov_df <- as.data.frame(dist_sub_paov)
  dist_sub_paov_df <- dist_sub_paov_df[,colnames(dist_sub_paov_df)!="Df"]
  dist_sub_paov_df <- rownames_to_column(dist_sub_paov_df, "Factors")
  colnames(dist_sub_paov_df)[ncol(dist_sub_paov_df)] <- "p"
  dist_sub_paov_df <- add_column(dist_sub_paov_df, Timepoint=timepoint, .before = 1)
  
  return(dist_sub_paov_df)
}

#100ppm
fdist_100ppm_paov <- rbind(
  fun_dist_paov(timepoint="0 months", arsenic=c("0ppm","100ppm")),
  fun_dist_paov(timepoint="1 month", arsenic=c("0ppm","100ppm")),
  fun_dist_paov(timepoint="2 months", arsenic=c("0ppm","100ppm")),
  fun_dist_paov(timepoint="3 months", arsenic=c("0ppm","100ppm")),
  fun_dist_paov(timepoint="4 months", arsenic=c("0ppm","100ppm")),
  fun_dist_paov(timepoint="5 months", arsenic=c("0ppm","100ppm"))
)

#adjust p values
padj <- na.omit(fdist_100ppm_paov$p) %>% p.adjust(.,method = "BH")
fdist_100ppm_paov$p_adj <- as.vector(rbind(padj, NA, NA))

pander(fdist_100ppm_paov, caption = "Arsenic effect (100ppm) over 5 months")

```

**Conclusion:** The fungal beta diversity is not altered by treating the soil with 100ppm Arsenic.

\pagebreak

We test if the fungal compositions differ between 0ppm and 200ppm arsenic concentration over 5 months.

```{r bray curtis distance fungi Arsenic 200ppm, warning=F, message=F, error=F, echo=F, eval=T}

### FUNGI ###

##200ppm
fdist_200ppm_paov <- rbind(
  fun_dist_paov(timepoint="0 months", arsenic=c("0ppm","200ppm")),
  fun_dist_paov(timepoint="1 month", arsenic=c("0ppm","200ppm")),
  fun_dist_paov(timepoint="2 months", arsenic=c("0ppm","200ppm")),
  fun_dist_paov(timepoint="3 months", arsenic=c("0ppm","200ppm")),
  fun_dist_paov(timepoint="4 months", arsenic=c("0ppm","200ppm")),
  fun_dist_paov(timepoint="5 months", arsenic=c("0ppm","200ppm"))
)

#adjust p values
padj <- na.omit(fdist_200ppm_paov$p) %>% p.adjust(.,method = "BH")
fdist_200ppm_paov$p_adj <- as.vector(rbind(padj, NA, NA))

pander(fdist_200ppm_paov, caption = "Arsenic effect (200ppm) over 5 months")

# #export as csv.
# temp1 <- rbind(bdist_100ppm_paov, bdist_200ppm_paov)
# temp1 <- add_column(temp1, taxa="bacteria", .before = 1)
# temp2 <- rbind(fdist_100ppm_paov, fdist_200ppm_paov)
# temp2 <- add_column(temp2, taxa="fungi", .before = 1)
# temp3 <- rbind(temp1, temp2)
# write.csv(temp3, "paper_tables/beta_div.csv", row.names = F)
# rm(temp1, temp2, temp3)

```

**Conclusion:** The fungal beta diversity is not shaped by 200ppm arsenic.

\pagebreak

## Figure 7 | Fungi: PCoA ordination

\vspace{5mm}

```{r fungi ordination all, echo=F, warning=F, message=F, eval=T}
#fig.height=5, fig.width=6

#all
source("functions/axis_label_pco.R")
fPHYSEQ_PCoA_bray <- phyloseq::ordinate(fPHYSEQ, method="PCoA", distance="bray")
p0 <- phyloseq::plot_ordination(fPHYSEQ, fPHYSEQ_PCoA_bray, color="Timepoint", shape="Arsenic", title = "Fungi: PCoA", axes = c(1,2)) #, label="Label"
p0$layers <- p0$layers[-1]
p0 <- p0 + geom_point(size=3)
p0 <- p0 + scale_color_manual(values=level_cols_Timepoint)
p0 <- p0 + scale_shape_manual(values=c(15,16,17))
p0 <- p0 + scale_size_manual(values=c(2,3))
p0 <- p0 + theme_bw()
fig6 <- p0
#png("fig1.png",width=3200, height=2600, res=600)
fig6
#dev.off()


```

## Figure 8 | Fungi: CAP ordination

\vspace{5mm}

```{r fungi all CAP, echo=F, warning=F, eval=T}

# Figure X | PCoA ordination all

#all

all_CAP_bray <- ordinate(fPHYSEQ, method="CAP", ~ Arsenic * Timepoint, distance="bray") #CAP
all_CAP_bray_var_tbl <- variability_table(all_CAP_bray) # extract variation details
all_CAP_bray_anova <- anova.cca(all_CAP_bray, permutations=999) #Anova

#pander(all_CAP_bray_anova[1:4], caption="all")

#prune PHYSEQ for plot
phylum.sum <- tapply(taxa_sums(fPHYSEQ), tax_table(fPHYSEQ)[, "labels"], sum, na.rm=T)
topphyla <- names(sort(phylum.sum, T))[1:6]
all_phy_sub <- prune_taxa((tax_table(fPHYSEQ)[, "labels"] %in% topphyla), fPHYSEQ)

# plot sample scores
score <- paste("[ ~ Arsenic * Timepoint: ",
               format(all_CAP_bray_var_tbl["constrained", "proportion"] * 100, digits=2, nsmall=1),
               "% of variance, P = ",
               format(all_CAP_bray_anova[1, 4], digits=2),
               "]", sep = "")

#plot
p0 <- phyloseq::plot_ordination(all_phy_sub, all_CAP_bray, color="Timepoint", shape="Arsenic", title =  "Fungi: CAP")
p0$layers <- p0$layers[-1]
p0 <- p0 + geom_point(size=3)
p0 <- p0 + scale_color_manual(values=level_cols_Timepoint)
p0 <- p0 + scale_shape_manual(values=c(15,16,17))
p0 <- p0 + scale_size_manual(values=c(2,3))
p0 <- p0 + labs(subtitle = score)
p0 <- p0 + theme_bw()
CAP_all <- p0
par(mar=c(4,4,4,4), oma=c(4,4,4,4))
print(CAP_all)

#saveRDS(CAP_all, "paper_figs/RDS/fig8.RDS")

```



